<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Challan Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            border-radius: 5px;
        }
        .form-section, .challan-preview {
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .btn-danger {
            background: #f44336;
        }
        .btn-danger:hover {
            background: #d32f2f;
        }
        .btn-secondary {
            background: #2196F3;
        }
        .btn-secondary:hover {
            background: #0b7dda;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .page {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            padding: 10mm;
            box-sizing: border-box;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            background: white;
        }
        .history-item {
            padding: 10px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            background: white;
            border-radius: 4px;
        }
        .history-item:hover {
            background: #f9f9f9;
        }
        .history-actions {
            margin-top: 10px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .page, .page * {
                visibility: visible;
            }
            .page {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                box-shadow: none;
                margin: 0;
                padding: 10mm;
            }
        }
        
        /* Delivery Challan Specific Styles */
        .header {
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .company-name {
            font-size: 18px;
            font-weight: bold;
        }
        .document-title {
            font-size: 16px;
            font-weight: bold;
            text-decoration: underline;
            margin: 10px 0;
            text-align: center;
        }
        .address-block {
            display: flex;
            margin-bottom: 15px;
        }
        .from-address, .consignee-address, .buyer-address {
            flex: 1;
            border: 1px solid #000;
            padding: 5px;
            margin-right: 5px;
        }
        .address-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        .details-table td {
            border: 1px solid #000;
            padding: 5px;
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        .items-table th, .items-table td {
            border: 1px solid #000;
            padding: 5px;
            text-align: left;
        }
        .items-table th {
            background-color: #f2f2f2;
        }
        .total-amount {
            margin-top: 10px;
            font-weight: bold;
        }
        .footer {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        .signature {
            width: 200px;
            border-top: 1px solid #000;
            text-align: center;
            padding-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Delivery Challan Generator</h1>
        
        <!-- Form Section -->
        <div class="form-section">
            <h2>Challan Details</h2>
            <div class="form-group">
                <label>Delivery Note No.</label>
                <input type="text" id="deliveryNoteNo" placeholder="e.g., 291C1100013602">
            </div>
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="challanDate">
            </div>
            <div class="form-group">
                <label>Document Type</label>
                <select id="documentType">
                    <option value="ORIGINAL FOR RECIPIENT">ORIGINAL FOR RECIPIENT</option>
                    <option value="DUPLICATE FOR SUPPLIER">DUPLICATE FOR SUPPLIER</option>
                </select>
            </div>
            
            <h3>From (Consignor)</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="consignorName" placeholder="Consignor Name">
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="consignorAddress" rows="3" placeholder="Consignor Address"></textarea>
            </div>
            <div class="form-group">
                <label>GSTIN</label>
                <input type="text" id="consignorGST" placeholder="Consignor GSTIN">
            </div>
            <div class="form-group">
                <label>State Code</label>
                <input type="text" id="consignorStateCode" placeholder="State Code">
            </div>
            
            <h3>Consignee (Ship to)</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="consigneeName" placeholder="Consignee Name">
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="consigneeAddress" rows="3" placeholder="Consignee Address"></textarea>
            </div>
            <div class="form-group">
                <label>GSTIN</label>
                <input type="text" id="consigneeGST" placeholder="Consignee GSTIN">
            </div>
            <div class="form-group">
                <label>State Code</label>
                <input type="text" id="consigneeStateCode" placeholder="State Code">
            </div>
            
            <h3>Buyer (Bill to)</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="buyerName" placeholder="Buyer Name">
            </div>
            <div class="form-group">
                <label>Address</label>
                <textarea id="buyerAddress" rows="3" placeholder="Buyer Address"></textarea>
            </div>
            <div class="form-group">
                <label>GSTIN</label>
                <input type="text" id="buyerGST" placeholder="Buyer GSTIN">
            </div>
            <div class="form-group">
                <label>State Code</label>
                <input type="text" id="buyerStateCode" placeholder="State Code">
            </div>
            
            <h3>Dispatch Details</h3>
            <div class="form-group">
                <label>Dispatched through</label>
                <input type="text" id="dispatchedThrough" placeholder="Dispatched through">
            </div>
            <div class="form-group">
                <label>Destination</label>
                <input type="text" id="destination" placeholder="Destination">
            </div>
            <div class="form-group">
                <label>Vehicle No.</label>
                <input type="text" id="vehicleNo" placeholder="Vehicle Number">
            </div>
            <div class="form-group">
                <label>eWay Bill No.</label>
                <input type="text" id="ewayBillNo" placeholder="eWay Bill Number">
            </div>
            
            <h3>Items</h3>
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Marks & Nos.</th>
                        <th>Description</th>
                        <th>HSN/SAC</th>
                        <th>Quantity</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="itemsBody">
                    <!-- Items will be added here -->
                </tbody>
            </table>
            <button onclick="addItem()"><i class="fas fa-plus"></i> Add Item</button>
            
            <div class="form-group">
                <label>Additional Notes</label>
                <textarea id="notes" rows="2" placeholder="Additional notes">E. & O.E</textarea>
            </div>
            
            <button onclick="generateChallan()"><i class="fas fa-file-invoice"></i> Generate Challan</button>
            <button onclick="saveChallan()"><i class="fas fa-save"></i> Save to History</button>
        </div>
        
        <!-- Challan Preview -->
        <div class="challan-preview">
            <h2>Delivery Challan Preview</h2>
            <div id="challanPreview" class="page">
                <!-- Challan will be rendered here -->
            </div>
            <button onclick="printChallan()"><i class="fas fa-print"></i> Print</button>
            <button onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export to PDF</button>
        </div>
        
        <!-- Challan History -->
        <div class="challan-history">
            <h2>Challan History</h2>
            <div id="historyList">
                <!-- Saved challans will appear here -->
            </div>
        </div>
    </div>

    <script>
        // Initialize jsPDF
        const { jsPDF } = window.jspdf;
        
        // Sample data
        document.getElementById('deliveryNoteNo').value = '291C' + Math.floor(Math.random() * 10000000);
        document.getElementById('challanDate').valueAsDate = new Date();
        
        // Add a new item row
        function addItem() {
            const tbody = document.getElementById('itemsBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${tbody.children.length + 1}</td>
                <td><input type="text" class="item-marks" placeholder="Marks & Nos."></td>
                <td><input type="text" class="item-desc" placeholder="Description"></td>
                <td><input type="text" class="item-hsn" placeholder="HSN/SAC"></td>
                <td><input type="number" class="item-qty" placeholder="Qty" onchange="calculateRow(this)"></td>
                <td><input type="number" class="item-rate" placeholder="Rate" onchange="calculateRow(this)"></td>
                <td class="item-amount">0.00</td>
                <td><button onclick="removeItem(this)" class="btn-danger"><i class="fas fa-trash"></i></button></td>
            `;
            tbody.appendChild(row);
        }
        
        // Remove an item row
        function removeItem(button) {
            const row = button.closest('tr');
            row.remove();
            updateItemNumbers();
        }
        
        // Update item numbers sequentially
        function updateItemNumbers() {
            const rows = document.querySelectorAll('#itemsBody tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }
        
        // Calculate row amount
        function calculateRow(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
            const rate = parseFloat(row.querySelector('.item-rate').value) || 0;
            const amount = qty * rate;
            row.querySelector('.item-amount').textContent = amount.toFixed(2);
        }
        
        // Calculate total amount
        function calculateTotal() {
            const amounts = document.querySelectorAll('.item-amount');
            let total = 0;
            amounts.forEach(amt => {
                total += parseFloat(amt.textContent) || 0;
            });
            return total;
        }
        
        // Generate challan preview
        function generateChallan() {
            const deliveryNoteNo = document.getElementById('deliveryNoteNo').value;
            const challanDate = document.getElementById('challanDate').value;
            const documentType = document.getElementById('documentType').value;
            const consignorName = document.getElementById('consignorName').value;
            const consignorAddress = document.getElementById('consignorAddress').value;
            const consignorGST = document.getElementById('consignorGST').value;
            const consignorStateCode = document.getElementById('consignorStateCode').value;
            const consigneeName = document.getElementById('consigneeName').value;
            const consigneeAddress = document.getElementById('consigneeAddress').value;
            const consigneeGST = document.getElementById('consigneeGST').value;
            const consigneeStateCode = document.getElementById('consigneeStateCode').value;
            const buyerName = document.getElementById('buyerName').value;
            const buyerAddress = document.getElementById('buyerAddress').value;
            const buyerGST = document.getElementById('buyerGST').value;
            const buyerStateCode = document.getElementById('buyerStateCode').value;
            const dispatchedThrough = document.getElementById('dispatchedThrough').value;
            const destination = document.getElementById('destination').value;
            const vehicleNo = document.getElementById('vehicleNo').value;
            const ewayBillNo = document.getElementById('ewayBillNo').value;
            const notes = document.getElementById('notes').value;
            
            // Get items
            const items = [];
            document.querySelectorAll('#itemsBody tr').forEach(row => {
                items.push({
                    marks: row.querySelector('.item-marks').value,
                    desc: row.querySelector('.item-desc').value,
                    hsn: row.querySelector('.item-hsn').value,
                    qty: row.querySelector('.item-qty').value,
                    rate: row.querySelector('.item-rate').value,
                    amount: row.querySelector('.item-amount').textContent
                });
            });
            
            const total = calculateTotal();
            
            // Generate HTML for challan
            const challanHTML = `
                <div class="header">
                    <div class="company-name">${consignorName}</div>
                    <div>${consignorAddress.replace(/\n/g, '<br>')}</div>
                    <div>GSTIN/UIN: ${consignorGST} | State Name : ${consignorStateCode ? 'Andhra Pradesh' : ''}, Code : ${consignorStateCode}</div>
                </div>
                
                <div class="document-title">DELIVERY CHALLAN (${documentType})</div>
                
                <div class="address-block">
                    <div class="from-address">
                        <div class="address-title">Consignor (From)</div>
                        <div>${consignorName}</div>
                        <div>${consignorAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN/UIN: ${consignorGST}</div>
                        <div>State Name : ${consignorStateCode ? 'Andhra Pradesh' : ''}, Code : ${consignorStateCode}</div>
                    </div>
                    <div class="consignee-address">
                        <div class="address-title">Consignee (Ship to)</div>
                        <div>${consigneeName}</div>
                        <div>${consigneeAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN/UIN: ${consigneeGST}</div>
                        <div>State Name : ${consigneeStateCode ? 'Andhra Pradesh' : ''}, Code : ${consigneeStateCode}</div>
                    </div>
                    <div class="buyer-address">
                        <div class="address-title">Buyer (Bill to)</div>
                        <div>${buyerName}</div>
                        <div>${buyerAddress.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN/UIN: ${buyerGST}</div>
                        <div>State Name : ${buyerStateCode ? 'Andhra Pradesh' : ''}, Code : ${buyerStateCode}</div>
                    </div>
                </div>
                
                <table class="details-table">
                    <tr>
                        <td>Delivery Note No.<br><strong>${deliveryNoteNo}</strong></td>
                        <td>Reference No. & Date.</td>
                        <td>Buyer's Order No.</td>
                        <td>Dispatch Doc No.</td>
                    </tr>
                    <tr>
                        <td>Dispatched through<br><strong>${dispatchedThrough}</strong></td>
                        <td>Dated<br><strong>${new Date(challanDate).toLocaleDateString()}</strong></td>
                        <td>Mode/Terms of Payment</td>
                        <td>Other References</td>
                    </tr>
                    <tr>
                        <td>Destination<br><strong>${destination}</strong></td>
                        <td>Terms of Delivery</td>
                        <td>Vehicle No.<br><strong>${vehicleNo}</strong></td>
                        <td>eWay Bill No:<br><strong>${ewayBillNo}</strong></td>
                    </tr>
                </table>
                
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Sl No.</th>
                            <th>Marks & Nos./ Container No.</th>
                            <th>Description of Goods</th>
                            <th>HSN/SAC</th>
                            <th>Quantity</th>
                            <th>Rate per</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${items.map((item, index) => `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${item.marks}</td>
                                <td>${item.desc}</td>
                                <td>${item.hsn}</td>
                                <td>${item.qty}</td>
                                <td>${parseFloat(item.rate).toFixed(2)}</td>
                                <td>${parseFloat(item.amount).toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align: right;"><strong>Total</strong></td>
                            <td><strong>${items.reduce((sum, item) => sum + parseFloat(item.qty || 0), 0)}</strong></td>
                            <td></td>
                            <td><strong>₹ ${total.toFixed(2)}</strong></td>
                        </tr>
                    </tfoot>
                </table>
                
                <div class="total-amount">
                    Amount Chargeable (in words)<br>
                    <strong>${numberToWords(total)} Rupees Only</strong>
                </div>
                
                <div class="footer">
                    <div>${notes}</div>
                    <div class="signature">Recd. in Good Condition</div>
                    <div class="signature">for ${consignorName}<br>Authorised Signatory</div>
                </div>
            `;
            
            document.getElementById('challanPreview').innerHTML = challanHTML;
        }
        
        // Save challan to local storage
        function saveChallan() {
            const challanData = {
                id: Date.now(),
                deliveryNoteNo: document.getElementById('deliveryNoteNo').value,
                date: document.getElementById('challanDate').value,
                documentType: document.getElementById('documentType').value,
                consignor: {
                    name: document.getElementById('consignorName').value,
                    address: document.getElementById('consignorAddress').value,
                    gst: document.getElementById('consignorGST').value,
                    stateCode: document.getElementById('consignorStateCode').value
                },
                consignee: {
                    name: document.getElementById('consigneeName').value,
                    address: document.getElementById('consigneeAddress').value,
                    gst: document.getElementById('consigneeGST').value,
                    stateCode: document.getElementById('consigneeStateCode').value
                },
                buyer: {
                    name: document.getElementById('buyerName').value,
                    address: document.getElementById('buyerAddress').value,
                    gst: document.getElementById('buyerGST').value,
                    stateCode: document.getElementById('buyerStateCode').value
                },
                dispatch: {
                    through: document.getElementById('dispatchedThrough').value,
                    destination: document.getElementById('destination').value,
                    vehicleNo: document.getElementById('vehicleNo').value,
                    ewayBillNo: document.getElementById('ewayBillNo').value
                },
                items: Array.from(document.querySelectorAll('#itemsBody tr')).map(row => ({
                    marks: row.querySelector('.item-marks').value,
                    desc: row.querySelector('.item-desc').value,
                    hsn: row.querySelector('.item-hsn').value,
                    qty: row.querySelector('.item-qty').value,
                    rate: row.querySelector('.item-rate').value,
                    amount: row.querySelector('.item-amount').textContent
                })),
                notes: document.getElementById('notes').value,
                total: calculateTotal(),
                timestamp: new Date().toISOString()
            };
            
            let challans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
            challans.push(challanData);
            localStorage.setItem('deliveryChallans', JSON.stringify(challans));
            
            loadHistory();
            alert('Delivery Challan saved successfully!');
        }
        
        // Load saved challans from local storage
        function loadHistory() {
            const challans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
            const historyList = document.getElementById('historyList');
            
            historyList.innerHTML = challans.map(challan => `
                <div class="history-item" data-id="${challan.id}">
                    <strong>${challan.deliveryNoteNo}</strong> - ${new Date(challan.date).toLocaleDateString()}
                    <div>${challan.consignee.name} - ₹${challan.total.toFixed(2)} (${challan.documentType})</div>
                    <div class="history-actions">
                        <button onclick="viewChallan(${challan.id})"><i class="fas fa-eye"></i> View</button>
                        <button onclick="editChallan(${challan.id})"><i class="fas fa-edit"></i> Edit</button>
                        <button onclick="deleteChallan(${challan.id})" class="btn-danger"><i class="fas fa-trash"></i> Delete</button>
                        <button onclick="exportHistoryToPDF(${challan.id})" class="btn-secondary"><i class="fas fa-file-pdf"></i> PDF</button>
                    </div>
                </div>
            `).join('');
        }
        
        // View saved challan
        function viewChallan(id) {
            const challans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
            const challan = challans.find(ch => ch.id === id);
            
            if (challan) {
                const challanHTML = `
                    <div class="header">
                        <div class="company-name">${challan.consignor.name}</div>
                        <div>${challan.consignor.address.replace(/\n/g, '<br>')}</div>
                        <div>GSTIN/UIN: ${challan.consignor.gst} | State Name : ${challan.consignor.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.consignor.stateCode}</div>
                    </div>
                    
                    <div class="document-title">DELIVERY CHALLAN (${challan.documentType})</div>
                    
                    <div class="address-block">
                        <div class="from-address">
                            <div class="address-title">Consignor (From)</div>
                            <div>${challan.consignor.name}</div>
                            <div>${challan.consignor.address.replace(/\n/g, '<br>')}</div>
                            <div>GSTIN/UIN: ${challan.consignor.gst}</div>
                            <div>State Name : ${challan.consignor.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.consignor.stateCode}</div>
                        </div>
                        <div class="consignee-address">
                            <div class="address-title">Consignee (Ship to)</div>
                            <div>${challan.consignee.name}</div>
                            <div>${challan.consignee.address.replace(/\n/g, '<br>')}</div>
                            <div>GSTIN/UIN: ${challan.consignee.gst}</div>
                            <div>State Name : ${challan.consignee.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.consignee.stateCode}</div>
                        </div>
                        <div class="buyer-address">
                            <div class="address-title">Buyer (Bill to)</div>
                            <div>${challan.buyer.name}</div>
                            <div>${challan.buyer.address.replace(/\n/g, '<br>')}</div>
                            <div>GSTIN/UIN: ${challan.buyer.gst}</div>
                            <div>State Name : ${challan.buyer.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.buyer.stateCode}</div>
                        </div>
                    </div>
                    
                    <table class="details-table">
                        <tr>
                            <td>Delivery Note No.<br><strong>${challan.deliveryNoteNo}</strong></td>
                            <td>Reference No. & Date.</td>
                            <td>Buyer's Order No.</td>
                            <td>Dispatch Doc No.</td>
                        </tr>
                        <tr>
                            <td>Dispatched through<br><strong>${challan.dispatch.through}</strong></td>
                            <td>Dated<br><strong>${new Date(challan.date).toLocaleDateString()}</strong></td>
                            <td>Mode/Terms of Payment</td>
                            <td>Other References</td>
                        </tr>
                        <tr>
                            <td>Destination<br><strong>${challan.dispatch.destination}</strong></td>
                            <td>Terms of Delivery</td>
                            <td>Vehicle No.<br><strong>${challan.dispatch.vehicleNo}</strong></td>
                            <td>eWay Bill No:<br><strong>${challan.dispatch.ewayBillNo}</strong></td>
                        </tr>
                    </table>
                    
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Sl No.</th>
                                <th>Marks & Nos./ Container No.</th>
                                <th>Description of Goods</th>
                                <th>HSN/SAC</th>
                                <th>Quantity</th>
                                <th>Rate per</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${challan.items.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.marks}</td>
                                    <td>${item.desc}</td>
                                    <td>${item.hsn}</td>
                                    <td>${item.qty}</td>
                                    <td>${parseFloat(item.rate).toFixed(2)}</td>
                                    <td>${parseFloat(item.amount).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" style="text-align: right;"><strong>Total</strong></td>
                                <td><strong>${challan.items.reduce((sum, item) => sum + parseFloat(item.qty || 0), 0)}</strong></td>
                                <td></td>
                                <td><strong>₹ ${challan.total.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                    
                    <div class="total-amount">
                        Amount Chargeable (in words)<br>
                        <strong>${numberToWords(challan.total)} Rupees Only</strong>
                    </div>
                    
                    <div class="footer">
                        <div>${challan.notes}</div>
                        <div class="signature">Recd. in Good Condition</div>
                        <div class="signature">for ${challan.consignor.name}<br>Authorised Signatory</div>
                    </div>
                `;
                
                document.getElementById('challanPreview').innerHTML = challanHTML;
            }
        }
        
        // Edit saved challan
        function editChallan(id) {
            const challans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
            const challan = challans.find(ch => ch.id === id);
            
            if (challan) {
                document.getElementById('deliveryNoteNo').value = challan.deliveryNoteNo;
                document.getElementById('challanDate').value = challan.date;
                document.getElementById('documentType').value = challan.documentType;
                
                document.getElementById('consignorName').value = challan.consignor.name;
                document.getElementById('consignorAddress').value = challan.consignor.address;
                document.getElementById('consignorGST').value = challan.consignor.gst;
                document.getElementById('consignorStateCode').value = challan.consignor.stateCode;
                
                document.getElementById('consigneeName').value = challan.consignee.name;
                document.getElementById('consigneeAddress').value = challan.consignee.address;
                document.getElementById('consigneeGST').value = challan.consignee.gst;
                document.getElementById('consigneeStateCode').value = challan.consignee.stateCode;
                
                document.getElementById('buyerName').value = challan.buyer.name;
                document.getElementById('buyerAddress').value = challan.buyer.address;
                document.getElementById('buyerGST').value = challan.buyer.gst;
                document.getElementById('buyerStateCode').value = challan.buyer.stateCode;
                
                document.getElementById('dispatchedThrough').value = challan.dispatch.through;
                document.getElementById('destination').value = challan.dispatch.destination;
                document.getElementById('vehicleNo').value = challan.dispatch.vehicleNo;
                document.getElementById('ewayBillNo').value = challan.dispatch.ewayBillNo;
                
                document.getElementById('notes').value = challan.notes;
                
                // Clear existing items
                document.getElementById('itemsBody').innerHTML = '';
                
                // Add items
                challan.items.forEach(item => {
                    const tbody = document.getElementById('itemsBody');
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${tbody.children.length + 1}</td>
                        <td><input type="text" class="item-marks" value="${item.marks}"></td>
                        <td><input type="text" class="item-desc" value="${item.desc}"></td>
                        <td><input type="text" class="item-hsn" value="${item.hsn}"></td>
                        <td><input type="number" class="item-qty" value="${item.qty}" onchange="calculateRow(this)"></td>
                        <td><input type="number" class="item-rate" value="${item.rate}" onchange="calculateRow(this)"></td>
                        <td class="item-amount">${parseFloat(item.amount).toFixed(2)}</td>
                        <td><button onclick="removeItem(this)" class="btn-danger"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(row);
                });
                
                generateChallan();
            }
        }
        
        // Delete saved challan
        function deleteChallan(id) {
            if (confirm('Are you sure you want to delete this delivery challan?')) {
                let challans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
                challans = challans.filter(ch => ch.id !== id);
                localStorage.setItem('deliveryChallans', JSON.stringify(challans));
                loadHistory();
            }
        }
        
        // Print challan
        function printChallan() {
            window.print();
        }
        
        // Export current challan to PDF
        function exportToPDF() {
            const element = document.getElementById('challanPreview');
            html2canvas(element).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`delivery_challan_${document.getElementById('deliveryNoteNo').value}.pdf`);
            });
        }
        
        // Export history challan to PDF
        function exportHistoryToPDF(id) {
            const challans = JSON.parse(localStorage.getItem('deliveryChallans')) || [];
            const challan = challans.find(ch => ch.id === id);
            
            if (challan) {
                const challanHTML = `
                    <div class="page">
                        <div class="header">
                            <div class="company-name">${challan.consignor.name}</div>
                            <div>${challan.consignor.address.replace(/\n/g, '<br>')}</div>
                            <div>GSTIN/UIN: ${challan.consignor.gst} | State Name : ${challan.consignor.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.consignor.stateCode}</div>
                        </div>
                        
                        <div class="document-title">DELIVERY CHALLAN (${challan.documentType})</div>
                        
                        <div class="address-block">
                            <div class="from-address">
                                <div class="address-title">Consignor (From)</div>
                                <div>${challan.consignor.name}</div>
                                <div>${challan.consignor.address.replace(/\n/g, '<br>')}</div>
                                <div>GSTIN/UIN: ${challan.consignor.gst}</div>
                                <div>State Name : ${challan.consignor.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.consignor.stateCode}</div>
                            </div>
                            <div class="consignee-address">
                                <div class="address-title">Consignee (Ship to)</div>
                                <div>${challan.consignee.name}</div>
                                <div>${challan.consignee.address.replace(/\n/g, '<br>')}</div>
                                <div>GSTIN/UIN: ${challan.consignee.gst}</div>
                                <div>State Name : ${challan.consignee.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.consignee.stateCode}</div>
                            </div>
                            <div class="buyer-address">
                                <div class="address-title">Buyer (Bill to)</div>
                                <div>${challan.buyer.name}</div>
                                <div>${challan.buyer.address.replace(/\n/g, '<br>')}</div>
                                <div>GSTIN/UIN: ${challan.buyer.gst}</div>
                                <div>State Name : ${challan.buyer.stateCode ? 'Andhra Pradesh' : ''}, Code : ${challan.buyer.stateCode}</div>
                            </div>
                        </div>
                        
                        <table class="details-table">
                            <tr>
                                <td>Delivery Note No.<br><strong>${challan.deliveryNoteNo}</strong></td>
                                <td>Reference No. & Date.</td>
                                <td>Buyer's Order No.</td>
                                <td>Dispatch Doc No.</td>
                            </tr>
                            <tr>
                                <td>Dispatched through<br><strong>${challan.dispatch.through}</strong></td>
                                <td>Dated<br><strong>${new Date(challan.date).toLocaleDateString()}</strong></td>
                                <td>Mode/Terms of Payment</td>
                                <td>Other References</td>
                            </tr>
                            <tr>
                                <td>Destination<br><strong>${challan.dispatch.destination}</strong></td>
                                <td>Terms of Delivery</td>
                                <td>Vehicle No.<br><strong>${challan.dispatch.vehicleNo}</strong></td>
                                <td>eWay Bill No:<br><strong>${challan.dispatch.ewayBillNo}</strong></td>
                            </tr>
                        </table>
                        
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th>Sl No.</th>
                                    <th>Marks & Nos./ Container No.</th>
                                    <th>Description of Goods</th>
                                    <th>HSN/SAC</th>
                                    <th>Quantity</th>
                                    <th>Rate per</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${challan.items.map((item, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${item.marks}</td>
                                        <td>${item.desc}</td>
                                        <td>${item.hsn}</td>
                                        <td>${item.qty}</td>
                                        <td>${parseFloat(item.rate).toFixed(2)}</td>
                                        <td>${parseFloat(item.amount).toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" style="text-align: right;"><strong>Total</strong></td>
                                    <td><strong>${challan.items.reduce((sum, item) => sum + parseFloat(item.qty || 0), 0)}</strong></td>
                                    <td></td>
                                    <td><strong>₹ ${challan.total.toFixed(2)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                        
                        <div class="total-amount">
                            Amount Chargeable (in words)<br>
                            <strong>${numberToWords(challan.total)} Rupees Only</strong>
                        </div>
                        
                        <div class="footer">
                            <div>${challan.notes}</div>
                            <div class="signature">Recd. in Good Condition</div>
                            <div class="signature">for ${challan.consignor.name}<br>Authorised Signatory</div>
                        </div>
                    </div>
                `;
                
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = challanHTML;
                document.body.appendChild(tempDiv);
                
                html2canvas(tempDiv.firstChild).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(`delivery_challan_${challan.deliveryNoteNo}.pdf`);
                    document.body.removeChild(tempDiv);
                });
            }
        }
        
        // Convert number to words (simplified)
        function numberToWords(num) {
            const single = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const double = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const formatTenth = (digit, prev) => {
                return 0 == digit ? '' : ' ' + (1 == digit ? double[prev] : tens[digit]);
            };
            const formatOther = (digit, next, denom) => {
                return (0 != digit && 1 != next ? ' ' + single[digit] : '') + (0 != next || digit > 0 ? ' ' + denom : '');
            };
            
            let str = '';
            let rupees = Math.floor(num);
            let paise = Math.round((num - rupees) * 100);
            
            if (rupees > 0) {
                str += single[rupees] || `${tens[Math.floor(rupees / 10)]} ${single[rupees % 10]}`;
                if (rupees >= 10000000) {
                    str += ' Crore';
                } else if (rupees >= 100000) {
                    str += ' Lakh';
                } else if (rupees >= 1000) {
                    str += ' Thousand';
                } else if (rupees >= 100) {
                    str += ' Hundred';
                }
            }
            
            if (paise > 0) {
                str += ` and ${single[paise] || `${tens[Math.floor(paise / 10)]} ${single[paise % 10]}`} Paise`;
            }
            
            return str || 'Zero';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Add 3 empty items by default
            addItem();
            addItem();
            addItem();
            
            loadHistory();
            generateChallan();
        });
    </script>
</body>
</html>
